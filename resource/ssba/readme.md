This folder is to generate poison data in ssba.py ("--attack_train_replace_imgs_path" and 
"--attack_test_replace_imgs_path" should receive two path for poisoned training data and poisoned testing data, respectively).


Step 1: 

Choose the dataset you want to poison, and run the following command to convert the dataset into seperate image files in the same folder:
    eg. 

```shell
python dataset_convert_into_images.py --dataset {dataset_name}
```

先执行dataset_convert_into_images.py，生成图片格式的数据集


(If you do not want to use the dataset we provided, you can also use your own dataset. Then you should put the training images and testing images separately into two folders.)

Step 2:

Run the following command to train the autoencoder on given **training** dataest:

执行，自动获取autoencoder

eg.

```shell
  python train.py \
  --data_dir /path/to/images/ \
  --output_dir /path/to/output/ \
  --EXP_NAME customized_experiment_name \
  --use_celeba_preprocessing \
  --random_seed 0 \
  --fingerprint_length 100 \
  --image_resolution 128 \
  --num_epochs 20 \
  --batch_size 64 \
  --use_residual 0 \
  --use_modulated 0 \
  --fc_layers 0 \
  --fused_conv 0
  ```
  where
  - `use_celeba_preprocessing` needs to be active if and only if using CelebA aligned and cropped images.

  如果使用CelebA数据集和cropped images，则需要开启这个选项，如果不使用，不要开启，cropped images似乎是一个CelebA的选项之类的
  
  - `image_resolution` indicates the image resolution for training. All the images in `data_dir` is center-cropped according to the shorter side and then resized to this resolution. When `use_celeba_preprocessing` is active, `image_resolution` has to be set as 128.

  这个选项表示图片的分辨率，所有在data_dir中的图片会被按照短的那一边进行中央裁剪并resize为这个分辨率

  - `output_dir` contains model snapshots, image snapshots, and log files. For model snapshots, `*_encoder.pth` and `*_decoder.pth` correspond to the fingerprint encoder and decoder respectively.

  output_dir保存模型的快照、图片快照和日志，
  
  - `use_residual` indicates the output mode of encoder. When it is set to 0, the output is exactly the encoded image. When it is set to 1, the output is the residual, and the encoded image is generated by residual + original image.
  
  这个选项设置encoder的输出，如果设为0，输出就是编码后图像，如果设置成1，输出就是残差，编码图像是通过残差和原始图像拼接成的

  - `use_modulated` indicates whether to use the modulated convolution layers in StyleGAN2. When it is 0, the model is just the normal StegaStamp.

  是否使用StyleGAN2，设置为0的时候，模型就是普通的StegaStamp
  
  - `fc_layers` indicates whether to add 8 fc layers to disentangle the fingerprints before it is sent to the encoder, just as the way in StyleGAN2.

  只有在使用StyleGAN2的时候才需要设置，是否使用8个fc层
  
  - `fused_conv` indicates the mode of modulated convolution as is shown in the figure below. When it is set to 0, the 'Fuse' option in modulated convolution is set to be False.

设置下图所示的调制卷积的模式。当设置为 0 时，调制卷积中的 'Fuse' 选项被设置为 False

- 'fingerprint_length' 是fingerprint的bit长度，没看出来是做什么用的

Step 3:

Run the following command to generate the poisoned training and testing data:

执行如下命令，生成中毒的训练集和测试集


eg.

```shell
# embedding training dataset
# 生成中毒的训练集
# cuda设置为-1，可以使用CPU
# poison_rate选项可以设置投毒比

python embed_fingerprints.py \
    --encoder_path {path to encoder pth file} \
    --data_dir {train_dataset_folder} \
    --output_dir {folder path that you put poisoned trainig images} \
    --image_resolution 32 \
    --identical_fingerprints \
    --check \
    --decoder_path {path to decoder pth file} \
    --batch_size 32 \
    --seed 0 \
    --encode_method bch \
    --secret {secret you want to encode into poisoned data} \
    --use_residual 0 \
    --use_modulated 0 \
    --fused_conv 0 \
    --fc_layers 0 \
    --cuda 0
    
# pack images into npy file
# 压缩为npy图片
python utils/pack_images.py \
  --path {folder path that you put poisoned trainig images} \
  --save_file_path {packed poisoned training data npy file path}
  
# embedding test dataset
python embed_fingerprints.py \
    --encoder_path {path to encoder pth file} \
    --data_dir {test_dataset_folder} \
    --output_dir {folder path that you put poisoned testing images} \
    --image_resolution 32 \
    --identical_fingerprints \
    --check \
    --decoder_path {path to decoder pth file} \
    --batch_size 32 \
    --seed 0 \
    --encode_method bch \
    --secret {secret you want to encode into poisoned data} \
    --use_residual 0 \
    --use_modulated 0 \
    --fused_conv 0 \
    --fc_layers 0 \
    --cuda 0

# pack images into npy file
python utils/pack_images.py \
  --path {folder path that you put poisoned testing images} \
  --save_file_path {packed poisoned testing data npy file path}

```
